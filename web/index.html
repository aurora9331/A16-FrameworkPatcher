<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Framework Patcher</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
<div class="container">
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fa-solid fa-cube"></i>
                <h1>Framework Patcher</h1>
            </div>
            <p class="subtitle">Android Framework dosyaları için kolay ve güvenli patchleme aracı.</p>
        </div>

        <!-- Tema seçici (artık "Sistem" seçeneği var, sistem tercihine göre otomatik uyum) -->
        <div class="theme-switcher" style="display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:18px;">
            <label for="themeColor"><i class="fa-solid fa-palette"></i> Tema Rengi:</label>
            <select id="themeColor" aria-label="Tema Seçimi">
                <option value="system">Sistem (Tarayıcı)</option>
                <option value="dark-blue">Koyu Mavi</option>
                <option value="dark-green">Koyu Yeşil</option>
                <option value="dark-purple">Koyu Mor</option>
                <option value="dark-red">Koyu Kırmızı</option>
                <option value="dark-glass">Glass (Cam - Koyu)</option>
                <option value="light-blue">Açık Mavi</option>
                <option value="light-green">Açık Yeşil</option>
                <option value="light-purple">Açık Mor</option>
                <option value="light-red">Açık Kırmızı</option>
                <option value="light-glass">Glass (Cam - Açık)</option>
            </select>
        </div>
    </header>

    <main class="main-content">
        <div class="form-container active">
            <div class="form-header">
                <h2><i class="fa-solid fa-wrench"></i> Patchleme Başlat</h2>
                <p>Gerekli alanları doldur ve patchlemeyi başlat!</p>
            </div>
            <form class="patcher-form" id="patchForm">
                <div class="jar-urls">
                    <h3><i class="fa-solid fa-link"></i> JAR Dosya URL'leri</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="framework_jar_url"><i class="fa-solid fa-cubes"></i> framework.jar URL</label>
                            <input type="url" id="framework_jar_url" name="framework_jar_url" required>
                        </div>
                        <div class="form-group">
                            <label for="services_jar_url"><i class="fa-solid fa-cogs"></i> services.jar URL</label>
                            <input type="url" id="services_jar_url" name="services_jar_url" required>
                        </div>
                        <div class="form-group">
                            <label for="miui_services_jar_url"><i class="fa-brands fa-android"></i> miui-services.jar URL</label>
                            <input type="url" id="miui_services_jar_url" name="miui_services_jar_url" required>
                        </div>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="android_api_level"><i class="fa-solid fa-code"></i> Android API Seviyesi</label>
                        <input type="number" id="android_api_level" name="android_api_level" value="36" readonly>
                    </div>
                    <div class="form-group">
                        <label for="custom_device_name"><i class="fa-solid fa-mobile-screen"></i> Özel Cihaz Adı</label>
                        <input type="text" id="custom_device_name" name="custom_device_name" required>
                    </div>
                    <div class="form-group">
                        <label for="custom_version"><i class="fa-solid fa-tag"></i> Özel Sürüm</label>
                        <input type="text" id="custom_version" name="custom_version" required>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary"><i class="fa-solid fa-bolt"></i> Patchlemeyi Başlat</button>
                </div>
            </form>
        </div>
    </main>

    <div class="modal" id="modalResult">
        <div class="modal-content">
            <div class="loading-spinner" id="modalLoading"></div>
            <i class="success-icon fa-solid fa-circle-check" id="modalSuccess" style="display:none;"></i>
            <i class="error-icon fa-solid fa-circle-xmark" id="modalError" style="display:none;"></i>
            <h3 id="modalTitle">İşlem Yapılıyor...</h3>
            <p id="modalMessage"></p>
            <button class="btn btn-secondary" id="modalClose" style="display:none;">Kapat</button>
            <button class="btn btn-action" id="modalWorkflow" style="display:none;">İş Akışını Gör</button>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <p>Framework Patcher | <span style="color:var(--accent)">Catppuccin Dark</span> ile tasarlandı.</p>
            <div class="footer-links">
                <a href="https://github.com/aurora9331/A16-FrameworkPatcher" target="_blank"><i class="fa-brands fa-github"></i> GitHub</a>
                <a href="https://catppuccin.com/" target="_blank"><i class="fa-solid fa-palette"></i> Catppuccin</a>
            </div>
        </div>
    </footer>
</div>

<script>
/*
  Tema mantığı:
  - Kullanıcı "Sistem (Tarayıcı)" seçerse sayfa otomatik olarak tarayıcı/OS'un prefers-color-scheme ayarına uyar.
  - Sistem teması değişirse (ör. kullanıcı OS'da koyu/açık değiştirdi) sayfa otomatik güncellenir (eğer seçim "system" ise).
  - Diğer seçimlerde kullanıcının tercihi kaydedilir ve doğrudan uygulanır.
  - dark-glass / light-glass seçildiğinde body'ye 'glass' sınıfı eklenir, ayrıca html (documentElement) üzerine uygun :root.* sınıfı eklenir.
*/

document.addEventListener('DOMContentLoaded', function () {
  const THEME_OPTIONS = [
    'system',
    'dark-blue','dark-green','dark-purple','dark-red','dark-glass',
    'light-blue','light-green','light-purple','light-red','light-glass'
  ];
  const themeSelect = document.getElementById('themeColor');
  const prefersDarkMQ = window.matchMedia('(prefers-color-scheme: dark)');

  function clearAllThemeClasses() {
    // :root-based classes -> add/remove on documentElement (html)
    ['dark-blue','dark-green','dark-purple','dark-red','dark-glass',
     'light-blue','light-green','light-purple','light-red','light-glass'
    ].forEach(cls => document.documentElement.classList.remove(cls));
    // glass effect controlled via body.glass
    document.body.classList.remove('glass');
  }

  function applyThemeByName(name) {
    clearAllThemeClasses();
    if (!name) return;
    if (name === 'system') {
      applySystemTheme(); // resolve based on prefers-color-scheme
      return;
    }
    // special handling for glass themes
    if (name === 'dark-glass') {
      document.documentElement.classList.add('dark-glass');
      document.body.classList.add('glass');
      return;
    }
    if (name === 'light-glass') {
      document.documentElement.classList.add('light-glass');
      document.body.classList.add('glass');
      return;
    }
    // normal themes: apply directly to :root (html)
    document.documentElement.classList.add(name);
  }

  function applySystemTheme() {
    if (prefersDarkMQ.matches) {
      // prefer dark system: pick a dark glass if you want or fallback to dark-blue
      // we choose dark-glass by default for a nice look; you can change mapping here
      document.documentElement.classList.add('dark-glass');
      document.body.classList.add('glass');
    } else {
      // prefer light system: use light-glass by default
      document.documentElement.classList.add('light-glass');
      document.body.classList.add('glass');
    }
  }

  // load saved preference
  const saved = (function() {
    try { return localStorage.getItem('selectedTheme'); } catch (e) { return null; }
  })() || 'system';

  // set select value safely
  if (themeSelect) {
    themeSelect.value = THEME_OPTIONS.includes(saved) ? saved : 'system';
  }

  // initial apply
  applyThemeByName(saved);

  // if user chooses a specific theme from select
  if (themeSelect) {
    themeSelect.addEventListener('change', function () {
      const val = this.value;
      applyThemeByName(val);
      try { localStorage.setItem('selectedTheme', val); } catch (e) {}
    });
  }

  // listen for system theme changes and update only if user chosen 'system'
  try {
    prefersDarkMQ.addEventListener
      ? prefersDarkMQ.addEventListener('change', e => {
          const cur = localStorage.getItem('selectedTheme') || 'system';
          if (cur === 'system') applySystemTheme();
        })
      : prefersDarkMQ.addListener(e => {
          const cur = localStorage.getItem('selectedTheme') || 'system';
          if (cur === 'system') applySystemTheme();
        });
  } catch (e) {
    // ignore older browsers
  }
});

/* ---------- Patcher form handling (mevcut davranış korunur) ---------- */
const patchForm = document.getElementById('patchForm');
const modal = document.getElementById('modalResult');
const modalTitle = document.getElementById('modalTitle');
const modalMessage = document.getElementById('modalMessage');
const modalLoading = document.getElementById('modalLoading');
const modalSuccess = document.getElementById('modalSuccess');
const modalError = document.getElementById('modalError');
const modalClose = document.getElementById('modalClose');
const modalWorkflow = document.getElementById('modalWorkflow');

if (patchForm) {
    patchForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        modal.style.display = 'flex';
        modalTitle.textContent = 'İşlem Yapılıyor...';
        modalMessage.textContent = 'Patchleme iş akışı başlatılıyor, lütfen bekleyin.';
        modalLoading.style.display = 'block';
        modalSuccess.style.display = 'none';
        modalError.style.display = 'none';
        modalClose.style.display = 'none';
        modalWorkflow.style.display = 'none';

        const formData = new FormData(patchForm);
        const inputs = Object.fromEntries(formData);

        try {
            const response = await fetch("https://a16-framework-patcher.vercel.app/api/trigger-patch", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(inputs)
            });
            const result = await response.json();

            modalLoading.style.display = 'none';
            if (response.ok) {
                modalSuccess.style.display = 'inline-block';
                modalTitle.textContent = 'Başarılı!';
                modalMessage.textContent = result.message || 'Patchleme iş akışı başarıyla başlatıldı.';
                modalWorkflow.style.display = 'inline-block';
            } else {
                modalError.style.display = 'inline-block';
                modalTitle.textContent = 'Hata!';
                modalMessage.textContent = result.message || 'Patchleme başlatılamadı.' + (result.error ? ' (' + JSON.stringify(result.error) + ')' : '');
                modalWorkflow.style.display = 'none';
            }
            modalClose.style.display = 'inline-block';
        } catch (err) {
            modalLoading.style.display = 'none';
            modalError.style.display = 'inline-block';
            modalTitle.textContent = 'Bağlantı Hatası!';
            modalMessage.textContent = err.message || 'Patchleme başlatılamadı.';
            modalClose.style.display = 'inline-block';
            modalWorkflow.style.display = 'none';
        }
    });
}

if (modalClose) {
    modalClose.addEventListener('click', function() {
        modal.style.display = 'none';
    });
}

if (modalWorkflow) {
    modalWorkflow.onclick = function() {
        window.open('https://github.com/aurora9331/A16-FrameworkPatcher/actions', '_blank');
    };
}
</script>
</body>
</html>
