name: Android 16 Framework Yama Arac覺

on:
  workflow_dispatch:
    inputs:
      framework_jar_url:
        description: 'framework.jar dosyas覺 i癟in URL'
        required: true
      services_jar_url:
        description: 'services.jar dosyas覺 i癟in URL'
        required: true
      miui_services_jar_url:
        description: 'miui-services.jar dosyas覺 i癟in URL'
        required: true
      android_api_level:
        description: 'Android API seviyesi'
        required: true
        default: '36'
      custom_device_name:
        description: 'Cihaz ad覺'
        required: true
      custom_version:
        description: 'Yama s羹r羹m羹'
        required: true

jobs:
  patch:
    name: Android 16 Framework Yama Arac覺
    runs-on: ubuntu-latest
    steps:
      - name: Depoyu kontrol et
        uses: actions/checkout@v4

      - name: Java 17 kurulumunu yap
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Sistem ba覺ml覺l覺klar覺n覺 y羹kle
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full wget zip python3

      - name: Ara癟lar klas繹r羹n羹 haz覺rla
        run: |
          mkdir -p tools
          if [ ! -f tools/apktool.jar ]; then
            wget -O tools/apktool.jar https://github.com/iBotPeaches/Apktool/releases/download/v2.9.3/apktool_2.9.3.jar
          fi

      - name: framework JAR dosyalar覺n覺 indir
        run: |
          wget -O framework.jar "${{ github.event.inputs.framework_jar_url }}"
          wget -O services.jar "${{ github.event.inputs.services_jar_url }}"
          wget -O miui-services.jar "${{ github.event.inputs.miui_services_jar_url }}"

      - name: Android 16 yama arac覺n覺 癟al覺t覺r
        run: |
          # D羹zeltme: helper.sh'a da izin ver
          chmod +x scripts/helper.sh
          chmod +x scripts/patcher_a16.sh
          ./scripts/patcher_a16.sh \
            "${{ github.event.inputs.android_api_level }}" \
            "${{ github.event.inputs.custom_device_name }}" \
            "${{ github.event.inputs.custom_version }}" \
            --framework --services --miui-services

      - name: Yay覺n klas繹rlerini haz覺rla
        run: |
          mkdir -p system/system/framework
          mkdir -p system_ext/framework
          cp framework.jar system/system/framework/framework.jar
          cp services.jar system/system/framework/services.jar
          cp miui-services.jar system_ext/framework/miui-services.jar

      - name: Yay覺n i癟in ZIP olutur
        run: |
          zip -r Framework-Patcher-${{ github.event.inputs.custom_device_name }}-${{ github.event.inputs.custom_version }}.zip system system_ext

      - name: Oluturulan dosyalar覺 listele
        run: |
          echo "Oluturulan dosyalar:"
          ls -R | grep -E 'framework\.jar$|services\.jar$|miui-services\.jar$|Framework-Patcher-'

      - name: Yay覺n bilgisini ayarla
        id: release_info
        run: |
          SAFE_VERSION=$(echo "${{ github.event.inputs.custom_version }}" | sed 's/[. ]/-/g')
          RELEASE_TAG="${{ github.event.inputs.custom_device_name }}_${SAFE_VERSION}"
          echo "tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "name=Android 16 Framework Yamas覺 - ${{ github.event.inputs.custom_device_name }} (${{ github.event.inputs.custom_version }})" >> $GITHUB_OUTPUT

      - name: ZIP dosyas覺n覺 bul
        id: find_zip
        run: |
          ZIP_FILE=$(ls Framework-Patcher-${{ github.event.inputs.custom_device_name }}*.zip)
          echo "file_path=${ZIP_FILE}" >> $GITHUB_OUTPUT

      - name: GitHub Yay覺n覺 olutur
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.release_info.outputs.tag }}
          name: ${{ steps.release_info.outputs.name }}
          files: ${{ steps.find_zip.outputs.file_path }}
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          # --- YEN襤 EKLENEN AIKLAMA BLM BURASI ---
          body: |
            ### Android 16 Framework Yamas覺
            
            **Cihaz:** ${{ github.event.inputs.custom_device_name }}
            **S羹r羹m:** ${{ github.event.inputs.custom_version }}
            **API Seviyesi:** ${{ github.event.inputs.android_api_level }}
            
            ---
            
            ####  Uygulanan Yamalar
            
            Bu paket, aa覺daki dosyalar覺 modifiye eder:
            
            * **framework.jar:** 襤mza dorulamas覺 (signature verification) ve `sharedUserId` kontrolleri atlat覺ld覺.
            * **services.jar:** S羹r羹m d羹羹rme (downgrade) kontrolleri ve imza kar覺lat覺rmalar覺 devre d覺覺 b覺rak覺ld覺.
            * **miui-services.jar:** MIUI'ye 繹zg羹 `IS_INTERNATIONAL_BUILD` kontrol羹 atlat覺ld覺 ve dier MIUI dorulamalar覺 (isolation, update checks) kald覺r覺ld覺.
