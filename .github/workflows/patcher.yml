name: Android 16 Framework Yama Aracı

on:
  workflow_dispatch:
    inputs:
      framework_jar_url:
        description: 'framework.jar dosyası için URL'
        required: true
      services_jar_url:
        description: 'services.jar dosyası için URL'
        required: true
      miui_services_jar_url:
        description: 'miui-services.jar dosyası için URL'
        required: true
      android_api_level:
        description: 'Android API seviyesi'
        required: true
        default: '36'
      custom_device_name:
        description: 'Cihaz adı'
        required: true
      custom_version:
        description: 'Yama sürümü'
        required: true

jobs:
  patch:
    name: Android 16 Framework Yama Aracı
    runs-on: ubuntu-latest
    steps:
      - name: Depoyu kontrol et
        uses: actions/checkout@v4

      - name: Java 17 kurulumunu yap
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Sistem bağımlılıklarını yükle
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full wget zip python3

      - name: Araçlar klasörünü hazırla
        run: |
          mkdir -p tools
          if [ ! -f tools/apktool.jar ]; then
            wget -O tools/apktool.jar https://github.com/iBotPeaches/Apktool/releases/download/v2.9.3/apktool_2.9.3.jar
          fi

      - name: framework JAR dosyalarını indir
        run: |
          wget -O framework.jar "${{ github.event.inputs.framework_jar_url }}"
          wget -O services.jar "${{ github.event.inputs.services_jar_url }}"
          wget -O miui-services.jar "${{ github.event.inputs.miui_services_jar_url }}"

      - name: Android 16 yama aracını çalıştır
        run: |
          chmod +x scripts/patcher_a16.sh
          ./scripts/patcher_a16.sh \
            "${{ github.event.inputs.android_api_level }}" \
            "${{ github.event.inputs.custom_device_name }}" \
            "${{ github.event.inputs.custom_version }}" \
            --framework --services --miui-services

      - name: Yayın klasörlerini hazırla
        run: |
          mkdir -p system/system/framework
          mkdir -p system_ext/framework
          cp framework.jar system/system/framework/framework.jar
          cp services.jar system/system/framework/services.jar
          cp miui-services.jar system_ext/framework/miui-services.jar

      - name: Yayın için ZIP oluştur
        run: |
          zip -r Framework-Patcher-${{ github.event.inputs.custom_device_name }}-${{ github.event.inputs.custom_version }}.zip system system_ext

      - name: Oluşturulan dosyaları listele
        run: |
          echo "Oluşturulan dosyalar:"
          ls -R | grep -E 'framework\\.jar$|services\\.jar$|miui-services\\.jar$|Framework-Patcher-'

      - name: Yayın bilgisini ayarla
        id: release_info
        run: |
          SAFE_VERSION=$(echo "${{ github.event.inputs.custom_version }}" | sed 's/[. ]/-/g')
          RELEASE_TAG="${{ github.event.inputs.custom_device_name }}_${SAFE_VERSION}"
          echo "tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "name=Android 16 Framework Yaması - ${{ github.event.inputs.custom_device_name }} (${{ github.event.inputs.custom_version }})" >> $GITHUB_OUTPUT

      - name: ZIP dosyasını bul
        id: find_zip
        run: |
          ZIP_FILE=$(ls Framework-Patcher-${{ github.event.inputs.custom_device_name }}*.zip)
          echo "file_path=${ZIP_FILE}" >> $GITHUB_OUTPUT

      - name: GitHub Yayını oluştur
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.release_info.outputs.tag }}
          name: ${{ steps.release_info.outputs.name }}
          files: ${{ steps.find_zip.outputs.file_path }}
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
